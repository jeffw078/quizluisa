<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <title>Cata-ventos da Lu√≠sa </title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none;
    }

    body {
      font-family: "Comic Neue", "Comic Sans MS", cursive, sans-serif;
      background: linear-gradient(to bottom, #87CEEB 0%, #B0E0E6 50%, #98FB98 100%);
      min-height: 100vh;
      overflow: hidden;
      cursor: crosshair;
    }

    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    .game-header {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      z-index: 1000;
      pointer-events: none;
    }

    .game-title {
      color: #ff6b9d;
      font-size: 1.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 10px;
    }

    .game-stats {
      display: flex;
      gap: 20px;
      justify-content: center;
    }

    .stat-box {
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid #ffd6e8;
      font-size: 1.1em;
      color: #ff6b9d;
      font-weight: bold;
    }

    .debug-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
    }

    .debug-btn {
      background: #ff4444;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9em;
      margin: 5px;
      font-family: inherit;
    }

    .debug-btn:hover {
      background: #cc3333;
    }

    .debug-btn.active {
      background: #44ff44;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .pinwheel {
      position: absolute;
      width: 60px;
      height: 60px;
      cursor: pointer;
      z-index: 10;
      animation: fall linear;
    }

    .pinwheel-blades {
      width: 50px;
  height: 50px;
  margin: 5px auto;
  position: relative;
  
  /* üéØ DESCOMENTE A LINHA ABAIXO E AJUSTE O CAMINHO: */
  background-image: url('pinwheel.png');  /* ‚úÖ ATIVADO */
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
    }

    .spin-right {
      animation: spinRight 1s linear infinite;
    }

    .spin-left {
      animation: spinLeft 1s linear infinite;
    }

    @keyframes spinRight {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes spinLeft {
      from { transform: rotate(0deg); }
      to { transform: rotate(-360deg); }
    }

    @keyframes fall {
      from { top: -60px; }
      to { top: 100vh; }
    }

    .bad-cloud {
      position: absolute;
      width: 60px;
      height: 40px;
      cursor: pointer;
      z-index: 10;
      animation: fall linear;
    }

    .cloud-shape {
      width: 50px;
      height: 25px;
      background: #666;
      border-radius: 25px;
      margin: 5px auto;
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .cloud-shape:before,
    .cloud-shape:after {
      content: '';
      position: absolute;
      background: #666;
      border-radius: 50%;
    }

    .cloud-shape:before {
      width: 20px;
      height: 20px;
      top: -10px;
      left: 10px;
    }

    .cloud-shape:after {
      width: 25px;
      height: 25px;
      top: -12px;
      right: 8px;
    }

    .lightning {
      position: absolute;
      top: 35px;
      left: 50%;
      transform: translateX(-50%);
      color: #FFD700;
      font-size: 1.2em;
      text-shadow: 0 0 5px #FFD700;
      animation: flicker 0.5s infinite alternate;
    }

    @keyframes flicker {
      0% { opacity: 1; }
      100% { opacity: 0.5; }
    }

    .bonus-heart {
      position: absolute;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 10;
      animation: fall linear;
    }

    .heart {
  width: 30px;
  height: 30px;
  margin: 5px auto;
  position: relative;
  background-image: url('heart.png');  /* ‚úÖ ATIVADO */
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
    }

   
    .heart:after {
      left: 0;
      transform: rotate(45deg);
      transform-origin: 15px 15px;
    }

    .effect {
      position: absolute;
      font-size: 1.5em;
      font-weight: bold;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
      pointer-events: none;
      z-index: 100;
      animation: effectFloat 1s ease-out forwards;
    }

    @keyframes effectFloat {
      0% {
        opacity: 1;
        transform: translateY(0px) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateY(-50px) scale(1.2);
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlide 0.3s ease-out;
    }

    @keyframes modalSlide {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .name-input {
      font-size: 1.2em;
      padding: 15px;
      border: 2px solid #ff6b9d;
      border-radius: 10px;
      margin: 20px 0;
      width: 250px;
      text-align: center;
    }

    .btn {
      background: #ff6b9d;
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 10px;
      font-size: 1.1em;
      cursor: pointer;
      margin: 10px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #e55a87;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #4ecdc4;
    }

    .btn-secondary:hover {
      background: #45b7d1;
    }

    .tab-buttons {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: #f0f0f0;
      cursor: pointer;
      border-radius: 10px 10px 0 0;
      margin: 0 2px;
      font-family: inherit;
    }

    .tab-btn.active {
      background: #ff6b9d;
      color: white;
    }

    .tab-content {
      display: none;
      text-align: left;
    }

    .tab-content.active {
      display: block;
    }

    .ranking-list {
      max-height: 300px;
      overflow-y: auto;
      background: #f9f9f9;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }

    .ranking-item {
      background: white;
      margin: 10px 0;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #ff6b9d;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .rules-text {
      text-align: left;
      line-height: 1.6;
    }

    .rules-text h3 {
      color: #ff6b9d;
      margin: 15px 0 10px 0;
    }

    .rules-text p {
      margin: 5px 0;
    }

    .hidden { display: none; }

    .mensagem-sucesso, .mensagem-erro, .mensagem-info {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
      max-width: 400px;
      border-radius: 5px;
      padding: 15px;
      margin: 10px 0;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="game-container" id="gameContainer">
    <div class="game-header">
      <div class="game-title">Cata-ventos da Lu√≠sa - N√≠vel <span id="level">1</span></div>
      <div class="game-stats">
        <div class="stat-box">Score: <span id="score">0</span></div>
        <div class="stat-box">‚ù§Ô∏è Vidas: <span id="lives">3</span></div>
        <div class="stat-box">Combo: <span id="combo">0</span></div>
      </div>
    </div>

    <div class="debug-controls">
      <!-- <button class="debug-btn" id="debugBtn" onclick="toggleDebug()">Debug OFF</button> -->
      <button class="btn" onclick="showRankingModal()" style="font-size: 0.9em; padding: 8px 12px;">üìä Ranking / Regras</button>
    </div>
  </div>

  <!-- Modal de nome -->
  <div class="modal" id="nameModal">
    <div class="modal-content">
      <h2>üéÆ Digite seu nome</h2>
      <input type="text" id="nameInput" class="name-input" placeholder="Seu nome..." maxlength="30">
      <br>
      <button class="btn" onclick="startGame()">Come√ßar!</button>
      <br>
      <button class="btn btn-secondary" onclick="showRankingModal()">üìä Ver Ranking / Regras </button>
    </div>
  </div>

  <!-- Modal de fim -->
  <div class="modal hidden" id="endModal">
    <div class="modal-content">
      <h2 id="endTitle">Game Over!</h2>
      <p id="endMessage"></p>
      <div id="posicaoJogador" style="background: #e3f2fd; padding: 10px; margin: 15px 0; border-radius: 8px; font-size: 0.9em; display: none;">
        <!-- Posi√ß√£o do jogador ser√° exibida aqui -->
      </div>
      <button class="btn" onclick="restart()">Jogar Novamente</button>
      <button class="btn" onclick="goHome()">Voltar ao Quiz</button>
      <button class="btn btn-secondary" onclick="showRankingModal()">üìä Ver Ranking</button>
    </div>
  </div>

  <!-- Modal de Ranking e Regras -->
  <div class="modal hidden" id="rankingModal">
    <div class="modal-content">
      <h2>üèÜ Ranking & Regras</h2>
      
      <div class="tab-buttons">
        <button class="tab-btn active" onclick="showTab('ranking')">üèÜ Ranking</button>
        <button class="tab-btn" onclick="showTab('rules')">üìã Regras</button>
      </div>

      <div id="rankingTab" class="tab-content active">
        <div id="rankingList" class="ranking-list">
          <!-- Rankings ser√£o inseridos aqui -->
        </div>
      
      </div>

      <div id="rulesTab" class="tab-content">
        <div class="rules-text">
          <h3>üéØ Objetivo</h3>
          <p>Clique nos cataventos coloridos que caem do c√©u para marcar pontos e avan√ßar de n√≠vel!</p>
          
          <h3>‚ö° Como Jogar</h3>
          <p>‚Ä¢ Clique nos <strong>cataventos coloridos</strong> para ganhar pontos</p>
          <p>‚Ä¢ Evite as <strong>nuvens com raios</strong> - elas tiram uma vida</p>
          <p>‚Ä¢ Colete <strong>cora√ß√µes rosa</strong> para ganhar vidas extras</p>
          <p>‚Ä¢ Fa√ßa combos clicando em sequ√™ncia para multiplicar pontos</p>
          
          <h3>üé™ Sistema de Pontos</h3>
          <p>‚Ä¢ Catavento normal: <strong>10 pontos</strong></p>
          <p>‚Ä¢ Combo 5x: <strong>+vida extra</strong></p>
          <p>‚Ä¢ A cada 5 n√≠veis: <strong>+vida extra</strong></p>
          <p>‚Ä¢ Catavento que passa: <strong>-5 pontos e -1 vida</strong></p>
          <p>‚Ä¢ Nuvem com raio: <strong>-1 vida e reset combo</strong></p>
          
          <h3>üìà Dificuldade</h3>
          <p>‚Ä¢ Objetos caem mais r√°pido a cada n√≠vel</p>
          <p>‚Ä¢ Mais nuvens ruins aparecem em n√≠veis altos</p>
          <p>‚Ä¢ Para subir de n√≠vel: <strong>N√≠vel √ó 15 pontos</strong></p>
          
          <h3>üèÜ Vidas</h3>
          <p>‚Ä¢ Inicie com <strong>3 vidas</strong></p>
          <p>‚Ä¢ M√°ximo de <strong>9 vidas</strong></p>
          <p>‚Ä¢ Game Over quando chegar a 0 vidas</p>
        </div>
      </div>

      <button class="btn" onclick="closeRankingModal()">Fechar</button>
    </div>
  </div>

  <!-- Biblioteca do Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    console.log('üöÄ VERS√ÉO 6.0 CARREGADA! Tabela ranking_cataventos corrigida!');

    // === CONFIGURA√á√ÉO DO SUPABASE ===
    // IMPORTANTE: A tabela no Supabase deve se chamar 'ranking_cataventos'
    const SUPABASE_URL = 'https://wnzdcucbveynkwgoskwg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduemRjdWNidmV5bmt3Z29za3dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMzgyODUsImV4cCI6MjA3MTkxNDI4NX0.2QeIFlwn4NLPWeMS_Ul8cauultfwUaHiGHY1XVyEcp0';
    
    let supabaseClient = null;

    // === VARI√ÅVEIS DO JOGO ===
    let gameRunning = false;
    let score = 0;
    let lives = 3;
    let combo = 0;
    let level = 1;
    let playerName = '';
    let debugMode = false;
    let gameStartTime = 0;

    // Configura√ß√µes do jogo
    const config = {
      getSpawnRate: (level) => Math.max(1200 - (level * 50), 400),
      getFallSpeed: (level) => Math.max(4 - (level * 0.15), 1.5),
      getBadChance: (level) => Math.min(0.05 + (level * 0.008), 0.15),
      getHeartChance: () => 0.06
    };

    // === FUN√á√ïES DO SUPABASE ===
    function inicializarSupabase() {
      try {
        if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
          supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log('‚úÖ Supabase inicializado com sucesso!');
          return true;
        } else {
          console.log('‚ö†Ô∏è Supabase ainda n√£o est√° dispon√≠vel');
          return false;
        }
      } catch (error) {
        console.error('‚ùå Erro ao inicializar Supabase:', error);
        return false;
      }
    }

    async function salvarRanking(nomeJogador, pontuacao, tempoSegundos, totalPerguntas, acertos) {
      try {
        console.log('üíæ Salvando ranking...', { nomeJogador, pontuacao, tempoSegundos });

        if (!supabaseClient) {
          if (!inicializarSupabase()) {
            throw new Error('Supabase n√£o dispon√≠vel');
          }
        }

        const dadosRanking = {
          nome_jogador: nomeJogador.trim(),
          pontuacao: pontuacao,
          tempo_segundos: tempoSegundos || 0,
          total_perguntas: totalPerguntas || Math.floor(pontuacao / 10),
          acertos: acertos || Math.floor(pontuacao / 10),
          percentual_acerto: totalPerguntas > 0 ? Math.round((acertos / totalPerguntas) * 100) : 100,
          data_jogo: new Date().toISOString()
        };

        // Verificar se jogador j√° existe
        const { data: existingData, error: searchError } = await supabaseClient
          .from('ranking_cataventos')
          .select('*')
          .eq('nome_jogador', nomeJogador.trim())
          .maybeSingle();

        if (searchError && searchError.code !== 'PGRST116') {
          throw searchError;
        }

        if (existingData) {
          if (pontuacao > existingData.pontuacao) {
            const { data, error } = await supabaseClient
              .from('ranking_cataventos')
              .update({
                pontuacao: pontuacao,
                tempo_segundos: tempoSegundos,
                total_perguntas: dadosRanking.total_perguntas,
                acertos: dadosRanking.acertos,
                percentual_acerto: dadosRanking.percentual_acerto,
                data_jogo: dadosRanking.data_jogo
              })
              .eq('nome_jogador', nomeJogador.trim())
              .select();

            if (error) throw error;
            console.log('‚úÖ Ranking atualizado!');
            mostrarMensagemSucesso('Novo recorde! Ranking atualizado!');
            return { success: true, data };
          } else {
            console.log('üìä Pontua√ß√£o n√£o supera o recorde');
            mostrarMensagemInfo(`Sua pontua√ß√£o: ${pontuacao}. Recorde: ${existingData.pontuacao}`);
            return { success: true, message: 'Pontua√ß√£o n√£o supera recorde' };
          }
        } else {
          const { data, error } = await supabaseClient
            .from('ranking_cataventos')
            .insert(dadosRanking)
            .select();

          if (error) throw error;
          console.log('‚úÖ Novo ranking salvo!');
          mostrarMensagemSucesso('Ranking salvo com sucesso!');
          return { success: true, data };
        }

      } catch (error) {
        console.error('‚ùå Erro ao salvar ranking:', error);
        mostrarMensagemErro('Erro: ' + error.message);
        salvarNoLocalStorage(nomeJogador, pontuacao, tempoSegundos);
        return { success: false, error };
      }
    }

    async function buscarRanking(limite = 10) {
      try {
        if (!supabaseClient) {
          if (!inicializarSupabase()) {
            return buscarRankingLocalStorage();
          }
        }

        const { data, error } = await supabaseClient
          .from('ranking_cataventos')
          .select('*')
          .order('pontuacao', { ascending: false })
          .order('tempo_segundos', { ascending: true })
          .limit(limite);

        if (error) {
          console.error('‚ùå Erro ao buscar ranking:', error);
          return buscarRankingLocalStorage();
        }

        return data || [];

      } catch (error) {
        console.error('‚ùå Erro ao buscar ranking:', error);
        return buscarRankingLocalStorage();
      }
    }

    async function buscarPosicaoJogador(nomeJogador) {
      try {
        const todosJogadores = await buscarRanking(1000);
        const posicao = todosJogadores.findIndex(jogador => 
          jogador.nome_jogador.toLowerCase() === nomeJogador.toLowerCase()
        ) + 1;

        return {
          posicao: posicao,
          total: todosJogadores.length,
          encontrado: posicao > 0
        };
      } catch (error) {
        console.error('‚ùå Erro ao buscar posi√ß√£o:', error);
        return { posicao: 0, total: 0, encontrado: false };
      }
    }

    // === FUN√á√ïES DE FALLBACK (LOCALSTORAGE) ===
    function salvarNoLocalStorage(nomeJogador, pontuacao, tempoSegundos) {
      try {
        console.log('üì± Salvando no localStorage...');
        
        const rankings = JSON.parse(localStorage.getItem('pinwheelRankings') || '[]');
        
        const novoRanking = {
          nome_jogador: nomeJogador,
          pontuacao: pontuacao,
          tempo_segundos: tempoSegundos,
          data_jogo: new Date().toISOString()
        };
        
        const indexExistente = rankings.findIndex(r => 
          r.nome_jogador.toLowerCase() === nomeJogador.toLowerCase()
        );
        
        if (indexExistente >= 0) {
          if (pontuacao > rankings[indexExistente].pontuacao) {
            rankings[indexExistente] = novoRanking;
            console.log('üì± Ranking atualizado localmente');
          }
        } else {
          rankings.push(novoRanking);
          console.log('üì± Novo ranking salvo localmente');
        }
        
        rankings.sort((a, b) => b.pontuacao - a.pontuacao);
        rankings.splice(10);
        
        localStorage.setItem('pinwheelRankings', JSON.stringify(rankings));
        
      } catch (error) {
        console.error('‚ùå Erro no localStorage:', error);
      }
    }

    function buscarRankingLocalStorage() {
      try {
        const rankings = JSON.parse(localStorage.getItem('pinwheelRankings') || '[]');
        return rankings.map(rank => ({
          nome_jogador: rank.nome_jogador || rank.nome,
          pontuacao: rank.pontuacao,
          tempo_segundos: rank.tempo_segundos || rank.tempo || 0,
          data_jogo: rank.data_jogo || rank.data
        })).slice(0, 10);
      } catch (error) {
        console.error('‚ùå Erro ao buscar localStorage:', error);
        return [];
      }
    }

    // === FUN√á√ïES DE MENSAGENS ===
    function mostrarMensagemSucesso(mensagem) {
      console.log('‚úÖ', mensagem);
      const div = document.createElement('div');
      div.className = 'mensagem-sucesso';
      div.innerHTML = `
        <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; border: 1px solid #c3e6cb;">
          <strong>‚úÖ Sucesso!</strong> ${mensagem}
        </div>
      `;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 5000);
    }

    function mostrarMensagemErro(mensagem) {
      console.error('‚ùå', mensagem);
      const div = document.createElement('div');
      div.className = 'mensagem-erro';
      div.innerHTML = `
        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;">
          <strong>‚ùå Erro!</strong> ${mensagem}
        </div>
      `;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 8000);
    }

    function mostrarMensagemInfo(mensagem) {
      console.log('‚ÑπÔ∏è', mensagem);
      const div = document.createElement('div');
      div.className = 'mensagem-info';
      div.innerHTML = `
        <div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 5px; border: 1px solid #bee5eb;">
          <strong>‚ÑπÔ∏è Info:</strong> ${mensagem}
        </div>
      `;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 6000);
    }

    // === FUN√á√ïES DE √ÅUDIO ===
    let audioContext;
    try {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    } catch(e) {
      console.log('Audio n√£o dispon√≠vel');
    }

    function playSound(freq, freq2 = null, duration = 0.1) {
      if (!audioContext) return;
      
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
      if (freq2) {
        oscillator.frequency.exponentialRampToValueAtTime(freq2, audioContext.currentTime + duration);
      }
      
      gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + duration);
    }

    function createEffect(x, y, text, color = '#4CAF50') {
      const effect = document.createElement('div');
      effect.className = 'effect';
      effect.textContent = text;
      effect.style.left = (x - 30) + 'px';
      effect.style.top = (y - 30) + 'px';
      effect.style.color = color;
      document.body.appendChild(effect);
      
      setTimeout(() => effect.remove(), 1000);
    }

    function updateUI() {
      document.getElementById('score').textContent = score;
      document.getElementById('level').textContent = level;
      document.getElementById('lives').textContent = lives;
      document.getElementById('combo').textContent = combo;
    }

    // === FUN√á√ïES DOS OBJETOS DO JOGO ===
    function createPinwheel() {
      const pinwheel = document.createElement('div');
      pinwheel.className = 'pinwheel';
      pinwheel.style.left = Math.random() * (window.innerWidth - 60) + 'px';
      
      const fallDuration = config.getFallSpeed(level);
      pinwheel.style.animationDuration = fallDuration + 's';
      
      const direction = Math.random() > 0.5 ? 'spin-right' : 'spin-left';
      pinwheel.innerHTML = `<div class="pinwheel-blades ${direction}"></div>`;
      
      let wasClicked = false;
      
      pinwheel.onclick = (e) => {
        if (!gameRunning || wasClicked) return;
        wasClicked = true;
        
        score += 10;
        combo++;
        
        playSound(800, 1200, 0.1);
        createEffect(e.clientX, e.clientY, `+10`);
        
        if (combo >= 5 && combo % 5 === 0) {
          createEffect(e.clientX + 30, e.clientY - 30, `${combo}x!`, '#FFD700');
        }
        
        if (combo === 20 || (combo > 20 && combo % 25 === 0)) {
          lives = Math.min(lives + 1, 9);
          createEffect(e.clientX, e.clientY - 50, '+1 ‚ù§Ô∏è', '#FF69B4');
        }
        
        checkLevelUp();
        updateUI();
        pinwheel.remove();
      };
      
      setTimeout(() => {
        if (!wasClicked && gameRunning && pinwheel.parentNode) {
          score = Math.max(0, score - 5);
          lives = Math.max(0, lives - 1);
          combo = 0;
          
          updateUI();
          createEffect(window.innerWidth / 2, 150, '-5 pontos', '#FF4444');
          createEffect(window.innerWidth / 2, 190, '-1 ‚ù§Ô∏è', '#FF4444');
          
          if (lives <= 0) {
            endGame();
          }
          
          pinwheel.remove();
        }
      }, (fallDuration * 1000) + 1000);
      
      document.getElementById('gameContainer').appendChild(pinwheel);
    }

    function createBadCloud() {
      const cloud = document.createElement('div');
      cloud.className = 'bad-cloud';
      cloud.style.left = Math.random() * (window.innerWidth - 60) + 'px';
      cloud.style.animationDuration = (config.getFallSpeed(level) + 1) + 's';
      
      cloud.innerHTML = `
        <div class="cloud-shape"></div>
        <div class="lightning">‚ö°</div>
      `;
      
      cloud.onclick = (e) => {
        if (!gameRunning) return;
        
        lives--;
        combo = 0;
        playSound(200, 100, 0.3);
        createEffect(e.clientX, e.clientY, '-1 ‚ù§Ô∏è', '#FF4444');
        updateUI();
        cloud.remove();
        
        if (lives <= 0) {
          endGame();
        }
      };
      
      cloud.onanimationend = () => cloud.remove();
      document.getElementById('gameContainer').appendChild(cloud);
    }

    function createBonusHeart() {
      const heart = document.createElement('div');
      heart.className = 'bonus-heart';
      heart.style.left = Math.random() * (window.innerWidth - 40) + 'px';
      heart.style.animationDuration = (config.getFallSpeed(level) + 1.5) + 's';
      
      heart.innerHTML = `<div class="heart"></div>`;
      
      heart.onclick = (e) => {
        if (!gameRunning) return;
        
        lives = Math.min(lives + 1, 9);
        playSound(1200, 800, 0.2);
        createEffect(e.clientX, e.clientY, '+1 ‚ù§Ô∏è', '#FF69B4');
        updateUI();
        heart.remove();
      };
      
      heart.onanimationend = () => heart.remove();
      document.getElementById('gameContainer').appendChild(heart);
    }

    function spawnObjects() {
      if (!gameRunning) return;
      
      const rand = Math.random();
      const heartChance = config.getHeartChance();
      const badChance = config.getBadChance(level);
      
      if (rand < heartChance) {
        createBonusHeart();
      } else if (rand < heartChance + badChance) {
        createBadCloud();
      } else {
        createPinwheel();
      }
      
      setTimeout(spawnObjects, config.getSpawnRate(level));
    }

    function checkLevelUp() {
      const required = level * 15;
      if (score >= required) {
        level++;
        
        if (level % 5 === 0) {
          lives = Math.min(lives + 1, 9);
          createEffect(window.innerWidth / 2, window.innerHeight / 2, `N√çVEL ${level}! +1 ‚ù§Ô∏è`, '#FFD700');
        } else {
          createEffect(window.innerWidth / 2, window.innerHeight / 2, `N√çVEL ${level}!`, '#FFD700');
        }
      }
    }

    // === FUN√á√ïES PRINCIPAIS DO JOGO ===
    function startGame() {
      const name = document.getElementById('nameInput').value.trim();
      if (!name) {
        alert('Digite seu nome!');
        return;
      }
      
      if (name.length < 2) {
        alert('Digite um nome com pelo menos 2 caracteres!');
        return;
      }
      
      playerName = name;
      document.getElementById('nameModal').classList.add('hidden');
      
      gameRunning = true;
      score = 0;
      lives = 3;
      combo = 0;
      level = 1;
      gameStartTime = Date.now();
      
      console.log('üéÆ Jogo iniciado!', { playerName, gameStartTime });
      
      updateUI();
      spawnObjects();
      
      try {
        audioContext.resume();
      } catch(e) {
        console.log('Audio n√£o dispon√≠vel');
      }
    }

    async function endGame() {
      gameRunning = false;
      
      console.log('üèÅ Fim de jogo!', { playerName, score, level, lives });
      
      document.querySelectorAll('.pinwheel, .bad-cloud, .bonus-heart').forEach(obj => obj.remove());
      
      const gameTimeSeconds = Math.round((Date.now() - gameStartTime) / 1000);
      
      let title, message;
      if (level >= 10) {
        title = 'üëë LENDA!';
        message = `Incr√≠vel! Voc√™ chegou ao n√≠vel ${level}!`;
      } else if (level >= 7) {
        title = 'üåü EXCELENTE!';
        message = `Parab√©ns! N√≠vel ${level} √© impressionante!`;
      } else if (level >= 4) {
        title = 'üéâ MUITO BOM!';
        message = `Bom trabalho! Chegou ao n√≠vel ${level}!`;
      } else {
        title = 'üí™ TENTE NOVAMENTE!';
        message = `N√≠vel ${level}. Voc√™ pode melhorar!`;
      }
      
      document.getElementById('endTitle').textContent = title;
      document.getElementById('endMessage').innerHTML = `
        ${message}<br><br>
        <strong>Pontua√ß√£o:</strong> ${score}<br>
        <strong>N√≠vel:</strong> ${level}<br>
        <strong>Tempo:</strong> ${gameTimeSeconds}s
      `;

      // Salvar ranking
      try {
        console.log('üíæ Salvando ranking...');
        
        const resultado = await salvarRanking(
          playerName,
          score,
          gameTimeSeconds,
          Math.floor(score / 10),
          Math.floor(score / 10)
        );
        
        // Buscar posi√ß√£o
        const posicaoInfo = await buscarPosicaoJogador(playerName);
        
        if (posicaoInfo.encontrado) {
          const emoji = posicaoInfo.posicao === 1 ? 'ü•á' : posicaoInfo.posicao === 2 ? 'ü•à' : posicaoInfo.posicao === 3 ? 'ü•â' : 'üèÖ';
          document.getElementById('posicaoJogador').innerHTML = `
            ${emoji} <strong>Voc√™ est√° na ${posicaoInfo.posicao}¬™ posi√ß√£o</strong> de ${posicaoInfo.total} jogadores!
          `;
          document.getElementById('posicaoJogador').style.display = 'block';
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao processar fim de jogo:', error);
      }
      
      document.getElementById('endModal').classList.remove('hidden');
    }

    // === FUN√á√ïES DE RANKING ===
    async function loadRanking() {
      const rankingList = document.getElementById('rankingList');
      
      try {
        console.log('üìä Carregando ranking...');
        rankingList.innerHTML = '<div style="text-align: center; padding: 20px;">üèÜ Carregando...</div>';
        
        const rankings = await buscarRanking(10);
        
        if (rankings.length === 0) {
          rankingList.innerHTML = '<p style="text-align: center; color: #888;">üèÜ Seja o primeiro!</p>';
          return;
        }
        
        rankingList.innerHTML = rankings.map((rank, index) => {
          const emoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
          const dataFormatada = rank.data_jogo ? 
            new Date(rank.data_jogo).toLocaleDateString('pt-BR') : 'N/A';
          const tempo = rank.tempo_segundos ? `${rank.tempo_segundos}s` : 'N/A';
          
          return `
            <div class="ranking-item">
              <strong>${emoji} ${index + 1}¬∫ ${rank.nome_jogador}</strong><br>
              <small>
                üéØ ${rank.pontuacao} pontos ‚Ä¢ 
                ‚è±Ô∏è ${tempo} ‚Ä¢ 
                üìÖ ${dataFormatada}
              </small>
            </div>
          `;
        }).join('');
        
        console.log('‚úÖ Ranking carregado:', rankings.length, 'jogadores');
        
      } catch(error) {
        console.error('‚ùå Erro ao carregar ranking:', error);
        rankingList.innerHTML = '<p style="color: red;">Erro ao carregar ranking</p>';
      }
    }

    async function clearRanking() {
      if (!confirm('Tem certeza que deseja limpar todo o ranking local?')) return;
      localStorage.removeItem('pinwheelRankings');
      console.log('üóëÔ∏è Ranking local limpo');
      await loadRanking();
    }

    // === FUN√á√ïES DE MODAL ===
    async function showRankingModal() {
      await loadRanking();
      document.getElementById('rankingModal').classList.remove('hidden');
    }

    function closeRankingModal() {
      document.getElementById('rankingModal').classList.add('hidden');
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      if (tabName === 'ranking') {
        loadRanking();
      }
    }

    function restart() {
      document.getElementById('endModal').classList.add('hidden');
      document.getElementById('nameModal').classList.remove('hidden');
      document.getElementById('nameInput').value = playerName || '';
      document.getElementById('posicaoJogador').style.display = 'none';
      
      if (debugMode) {
        toggleDebug();
      }
    }

    function goHome() {
      window.location.href = '/';
    }

    // === DEBUG MODE ===
    function toggleDebug() {
      debugMode = !debugMode;
      const btn = document.getElementById('debugBtn');
      
      if (debugMode) {
        btn.textContent = 'Debug ON';
        btn.classList.add('active');
        startAutoClick();
        console.log('üêõ Debug mode ATIVADO');
      } else {
        btn.textContent = 'Debug OFF';
        btn.classList.remove('active');
        stopAutoClick();
        console.log('üêõ Debug mode DESATIVADO');
      }
    }

    let autoClickInterval;

    function startAutoClick() {
      autoClickInterval = setInterval(() => {
        if (!gameRunning) return;
        
        const pinwheels = document.querySelectorAll('.pinwheel');
        pinwheels.forEach(pinwheel => {
          const rect = pinwheel.getBoundingClientRect();
          const event = new MouseEvent('click', {
            clientX: rect.left + rect.width / 2,
            clientY: rect.top + rect.height / 2
          });
          pinwheel.dispatchEvent(event);
        });
        
        const hearts = document.querySelectorAll('.bonus-heart');
        hearts.forEach(heart => {
          const rect = heart.getBoundingClientRect();
          const event = new MouseEvent('click', {
            clientX: rect.left + rect.width / 2,
            clientY: rect.top + rect.height / 2
          });
          heart.dispatchEvent(event);
        });
      }, 100);
    }

    function stopAutoClick() {
      if (autoClickInterval) {
        clearInterval(autoClickInterval);
        autoClickInterval = null;
      }
    }

    // === EVENTOS ===
    document.getElementById('nameInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') startGame();
    });

    window.addEventListener('beforeunload', () => {
      stopAutoClick();
    });

    // === INICIALIZA√á√ÉO ===
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üéÆ DOM carregado, aguardando Supabase...');
      setTimeout(() => {
        inicializarSupabase();
        console.log('‚úÖ Sistema totalmente inicializado!');
      }, 1000);
    });

    console.log('üéÆ Sistema de jogo inicializado!');
  </script>
</body>
</html>