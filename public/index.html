<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quiz da Luísa</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .mensagem-card {
      background-color: #fff8fc;
      border: 2px solid #ffd6e8;
      border-radius: 12px;
      padding: 12px;
      margin: 10px;
      box-shadow: 2px 2px 6px rgba(255, 182, 193, 0.3);
    }
    .mensagem-card p {
      margin: 5px 0;
    }
    .resultado-card {
      background-color: #f0fff4;
      border: 2px solid #a0e8c5;
      border-radius: 12px;
      padding: 12px;
      margin: 10px;
      box-shadow: 2px 2px 6px rgba(160, 232, 197, 0.3);
    }
    .resultado-card p {
      margin: 5px 0;
    }
    .loading {
      display: inline-block;
      margin: 20px;
      font-style: italic;
      color: #666;
    }
    .error {
      background-color: #ffe6e6;
      border: 2px solid #ff9999;
      border-radius: 12px;
      padding: 12px;
      margin: 10px;
      color: #cc0000;
    }
  </style>
</head>
<body>
  <header>
    <h1>Quiz da Luísa 🎉</h1>
    <img src="assets/pinwheel.png" class="pinwheel" alt="Cata-vento" onerror="this.style.display='none'">
  </header>
  <main>
    <div id="quiz-container">
      <div class="loading">Carregando perguntas...</div>
    </div>
    <button id="next-button" disabled>Próxima</button>
  </main>
  <footer>
    <p>Com carinho para a Luísa 💖</p>
  </footer>
  <script>
let currentQuestion = 0;
let questions = [];
let respostas = [];
let nomeConvidado = "";
let pontuacao = 0;

// Carregar perguntas
fetch('questions.json')
  .then(res => {
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    return res.json();
  })
  .then(data => {
    questions = data;
    perguntarNome();
  })
  .catch(error => {
    console.error('Erro ao carregar perguntas:', error);
    document.getElementById('quiz-container').innerHTML = `
      <div class="error">
        <h3>Erro ao carregar o quiz</h3>
        <p>Não foi possível carregar as perguntas. Tente recarregar a página.</p>
      </div>
    `;
  });

function perguntarNome() {
  const container = document.getElementById('quiz-container');
  container.innerHTML = `
    <p class="intro-msg">Você será convidado para o aniversário de 1 aninho da Luísa, mas para isso, primeiro, você deverá responder esse Quiz! Preparado?!</p>
    <div class="question">Qual o seu nome?</div>
    <input type="text" id="nomeInput" placeholder="Seu nome..." maxlength="50">
  `;
  
  const nextBtn = document.getElementById('next-button');
  const input = document.getElementById('nomeInput');
  
  nextBtn.disabled = false;
  nextBtn.onclick = () => {
    if (input.value.trim() !== "") {
      nomeConvidado = input.value.trim();
      showQuestion();
    } else {
      alert('Por favor, digite seu nome!');
    }
  };

  // Permitir pressionar Enter para continuar
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && input.value.trim() !== "") {
      nomeConvidado = input.value.trim();
      showQuestion();
    }
  });
}

function showQuestion() {
  const q = questions[currentQuestion];
  const container = document.getElementById('quiz-container');
  const nextBtn = document.getElementById('next-button');

  container.innerHTML = `
    <div class="question">Pergunta ${currentQuestion + 1} de ${questions.length}</div>
    <div class="question">${q.pergunta}</div>
    ${q.respostas.map((r, i) => `<button class="answer" data-index="${i}">${r}</button>`).join('')}
  `;

  nextBtn.disabled = true;

  document.querySelectorAll('.answer').forEach(btn => {
    btn.addEventListener('click', e => {
      const index = parseInt(e.target.dataset.index);
      const correta = index === q.correta;
      if (correta) pontuacao++;
      respostas.push({ pergunta: q.pergunta, resposta: q.respostas[index], correta });

      // Mostrar resposta correta
      btn.classList.add(correta ? 'correct' : 'incorrect');
      if (!correta) {
        document.querySelectorAll('.answer')[q.correta].classList.add('correct');
      }
      
      document.querySelectorAll('.answer').forEach(b => b.disabled = true);
      nextBtn.disabled = false;
    });
  });

  nextBtn.onclick = () => {
    currentQuestion++;
    if (currentQuestion < questions.length) {
      showQuestion();
    } else {
      mostrarMensagemFinal();
    }
  };
}

function mostrarMensagemFinal() {
  const container = document.getElementById('quiz-container');
  const nextBtn = document.getElementById('next-button');

  const porcentagem = Math.round((pontuacao / questions.length) * 100);
  let mensagemResultado = "";
  
  if (porcentagem >= 80) {
    mensagemResultado = "Excelente! Você conhece muito bem a Luísa! 🌟";
  } else if (porcentagem >= 60) {
    mensagemResultado = "Muito bom! Você sabe bastante sobre a Luísa! 👏";
  } else {
    mensagemResultado = "Legal! Agora você conhece mais sobre a Luísa! 💝";
  }

  container.innerHTML = `
    <div class="resultado-card">
      <h2>Parabéns, ${nomeConvidado}!</h2>
      <p>Você acertou <strong>${pontuacao}</strong> de ${questions.length} perguntas (${porcentagem}%).</p>
      <p>${mensagemResultado}</p>
      <p>Deixe uma mensagem carinhosa para a Luísa ler no futuro:</p>
      <textarea id="mensagem" placeholder="Escreva algo bonito para a Luísa..." rows="4" maxlength="500"></textarea>
      <br><br>
      <button id="enviarMensagem">Enviar Mensagem</button>
      <div id="statusEnvio"></div>
    </div>
  `;

  if (nextBtn) nextBtn.style.display = "none";
  
  document.getElementById('enviarMensagem').onclick = () => {
    const mensagem = document.getElementById('mensagem').value.trim();
    const statusDiv = document.getElementById('statusEnvio');
    const botaoEnviar = document.getElementById('enviarMensagem');
    
    if (mensagem) {
      botaoEnviar.disabled = true;
      botaoEnviar.textContent = 'Enviando...';
      statusDiv.innerHTML = '<p style="color: #666;">Salvando sua mensagem...</p>';
      
      const registro = {
        nome: nomeConvidado,
        pontuacao,
        total: questions.length,
        mensagem,
        data: new Date().toLocaleString('pt-BR')
      };
      
      fetch('/api/salvar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(registro)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Resposta salva:', data);
        statusDiv.innerHTML = '<p style="color: green;">✅ Mensagem salva com sucesso!</p>';
        
        // Aguardar um pouco antes de redirecionar
        setTimeout(() => {
          const whatsappMsg = encodeURIComponent(`Olá! Acabei de responder o Quiz da Luísa! Acertei ${pontuacao} de ${questions.length} perguntas. Quero o convite para o aniversário! 🎉`);
          window.open(`https://wa.me/5547988253536?text=${whatsappMsg}`, '_blank');
        }, 1500);
      })
      .catch(error => {
        console.error('Erro ao salvar:', error);
        statusDiv.innerHTML = '<p style="color: red;">❌ Erro ao salvar. Tente novamente.</p>';
        botaoEnviar.disabled = false;
        botaoEnviar.textContent = 'Tentar Novamente';
      });
    } else {
      alert('Por favor, escreva uma mensagem para a Luísa!');
    }
  }
}
  </script>
  
  <div style="text-align: center; margin: 30px;">
    <a href="jogo.html" style="color: #ff6b9d; text-decoration: none; font-size: 1.2em; background: #fff8fc; padding: 15px 25px; border-radius: 20px; border: 2px solid #ffd6e8; display: inline-block; margin: 10px; transition: all 0.3s ease;">
      🌪️ Jogar Mini-Game da Luísa!
    </a>
    <br>
    <a href="resultados.html" style="color: #ff6b9d; text-decoration: none; font-size: 1.1em;">
      📊 Ver Resultados do Quiz
    </a>
  </div>
</body>
</html>